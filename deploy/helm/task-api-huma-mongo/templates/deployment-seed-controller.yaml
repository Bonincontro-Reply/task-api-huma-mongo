{{- if .Values.seedController.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "task-api-huma-mongo.seedControllerName" . }}
  labels:
    {{- include "task-api-huma-mongo.labels" . | nindent 4 }}
    app.kubernetes.io/component: seed-controller
spec:
  replicas: {{ .Values.seedController.replicaCount }}
  selector:
    matchLabels:
      {{- include "task-api-huma-mongo.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: seed-controller
  template:
    metadata:
      labels:
        {{- include "task-api-huma-mongo.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: seed-controller
      {{- with .Values.seedController.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      serviceAccountName: {{ include "task-api-huma-mongo.seedControllerServiceAccountName" . }}
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.seedController.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: seed-controller
          image: "{{ include "task-api-huma-mongo.seedControllerImage" . }}"
          imagePullPolicy: {{ default .Values.image.api.pullPolicy .Values.seedController.image.pullPolicy }}
          command:
            - /app/seed-controller
          env:
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: SEED_CONTROLLER_POLL_INTERVAL
              value: {{ .Values.seedController.env.pollInterval | quote }}
            - name: SEED_JOB_IMAGE
              value: "{{ include "task-api-huma-mongo.seedJobImage" . }}"
            - name: SEED_JOB_IMAGE_PULL_POLICY
              value: {{ default .Values.image.api.pullPolicy .Values.seedJob.image.pullPolicy | quote }}
            - name: DEFAULT_MONGODB_URI
              value: {{ include "task-api-huma-mongo.mongodbUri" . | quote }}
            - name: DEFAULT_MONGODB_DB
              value: {{ .Values.api.env.mongodb.database | quote }}
            - name: DEFAULT_MONGODB_COLLECTION
              value: {{ .Values.api.env.mongodb.collection | quote }}
            - name: DEFAULT_SEED_COUNT
              value: {{ .Values.seedController.env.defaultSeedCount | quote }}
            - name: DEFAULT_SEED_RANDOM_SEED
              value: {{ .Values.seedController.env.defaultSeedRandomSeed | quote }}
            - name: DEFAULT_SEED_MODE
              value: {{ .Values.seedController.env.defaultSeedMode | quote }}
            - name: DEFAULT_SEED_TITLE_PREFIX
              value: {{ .Values.seedController.env.defaultSeedTitlePrefix | quote }}
            - name: DEFAULT_SEED_TAGS
              value: {{ .Values.seedController.env.defaultSeedTags | quote }}
            - name: DEFAULT_SEED_DONE_RATIO
              value: {{ .Values.seedController.env.defaultSeedDoneRatio | quote }}
            - name: DEFAULT_SEED_TAG_COUNT_MIN
              value: {{ .Values.seedController.env.defaultSeedTagCountMin | quote }}
            - name: DEFAULT_SEED_TAG_COUNT_MAX
              value: {{ .Values.seedController.env.defaultSeedTagCountMax | quote }}
            - name: DEFAULT_JOB_TTL_SECONDS_AFTER_FINISHED
              value: {{ .Values.seedController.env.defaultJobTtlSecondsAfterFinished | quote }}
            - name: DEFAULT_JOB_BACKOFF_LIMIT
              value: {{ .Values.seedController.env.defaultJobBackoffLimit | quote }}
            - name: DEFAULT_JOB_ACTIVE_DEADLINE_SECONDS
              value: {{ .Values.seedController.env.defaultJobActiveDeadlineSeconds | quote }}
          {{- with .Values.seedController.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.seedController.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
